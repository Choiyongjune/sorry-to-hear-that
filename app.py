from flask import Flask, request, jsonify
import re

app = Flask(__name__)

# âœ… ê°ì • ë‹¨ì–´ ì‚¬ì „: {ë‹¨ì–´: ê°•ë„ ì ìˆ˜(0~1)}
emotion_dict = {
    # ì§œì¦/í™”ë‚¨ ê´€ë ¨
    "ì§œì¦": 0.7, "ì§œì¦ë‚˜": 0.8, "ì§œì¦ë‚¨": 0.8, "ì§œì¦ë‚˜ìš”": 0.7, "ì§œì¦ë‚˜ë„¤": 0.7, "ì§œì¦ë‚˜ì„œ": 0.8,
    "í™”ë‚˜": 0.8, "í™”ë‚¬": 0.9, "ë¹¡ì¹˜": 1.0, "ì—´ë°›": 0.9, "í™”ë”±ì§€": 0.9, "ë¶ˆì¾Œ": 0.8, "ìŠ¤íŠ¸ë ˆìŠ¤": 0.7,
    "ì§œì¦ë‚˜ë²„": 0.9, "ê°œì§œì¦": 1.0, "ê°œë¹¡": 1.0, "ê°œì—´ë°›": 1.0,

    # ì„œìš´/ì‹¤ë§/ìš°ìš¸ ê´€ë ¨
    "ì„œìš´": 0.7, "ì„œìš´í•´": 0.8, "ì‹¤ë§": 0.8, "ì†ìƒ": 0.8, "ì„­ì„­": 0.8,
    "ìŠ¬í¼": 0.7, "ìš°ìš¸": 0.6, "ëˆˆë¬¼": 0.6, "ëˆˆë¬¼ì´": 0.6,

    # ì‹«ìŒ/ë¯¸ì›€ ê´€ë ¨
    "ì‹«ì–´": 0.7, "ë¯¸ì›Œ": 0.7, "ì •ë–¨ì–´": 0.8, "ì§ˆë ¤": 0.7, "í”¼ê³¤": 0.6,

    # ìš•ì„¤/ê°•í•œ í‘œí˜„
    "ë¹¡ì³": 1.0, "ã…ˆã„´": 1.0, "ì”¨ë°œ": 1.0, "ã……ã…‚": 1.0, "ì¡´ë‚˜": 1.0, "ã…ˆê°™": 1.0, "ê°œê°™": 1.0, "ë¯¸ì¹œ": 0.8,
    "ã…ã…Š": 0.8, "ëŒê² ": 0.7, "ê°œì—´ë°›ë„¤": 1.0
}

# âœ… ê°ì • ê°•ë„ íŒë‹¨ ê¸°ì¤€ (ì´ì „ë³´ë‹¤ ë‚®ê²Œ ì„¤ì •)
THRESHOLD = 0.5

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.get_json()
    user_msg = data.get("userRequest", {}).get("utterance", "").lower()

    # ê°ì • ë‹¨ì–´ íƒì§€ ë° ê°•ë„ ê³„ì‚°
    intensity = 0.0
    matched_words = []

    for word, score in emotion_dict.items():
        if re.search(word, user_msg):
            matched_words.append(word)
            intensity = max(intensity, score)

    # ë¡œê·¸ ì¶œë ¥ (Render Logsì—ì„œ í™•ì¸ ê°€ëŠ¥)
    print("ğŸ“© ì‚¬ìš©ì ì…ë ¥:", user_msg)
    print("ğŸ§© ê°ì • ë‹¨ì–´:", matched_words if matched_words else "ì—†ìŒ")
    print("ğŸ”¥ ê°ì • ê°•ë„:", intensity)
    print("ğŸ“¤ ì‘ë‹µ:", "ã…‡ã……ã…‡ã„±ã…‡" if intensity >= THRESHOLD else "(ë¬´ì‘ë‹µ)")
    print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")

    # ì‘ë‹µ ìƒì„±
    if intensity >= THRESHOLD:
        reply = "ã…‡ã……ã…‡ã„±ã…‡"
    else:
        reply = ""  # ê°ì •ì´ ì•½í•˜ë©´ ëŒ€ë‹µí•˜ì§€ ì•ŠìŒ

    return jsonify({
        "version": "2.0",
        "template": {
            "outputs": [{"simpleText": {"text": reply}}]
        }
    })

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
